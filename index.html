<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Health Stock Management</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-logo">ü©∫ Health Stock</div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="spreadsheet.html" target="_blank">Spreadsheet</a></li>
    </ul>
  </nav>

  <div class="container">
    <h1>ü©∫ Health Stock Management</h1>

    <form id="stock-form">
      <div class="form-group">
        <label for="date">üìÖ Date</label>
        <input type="date" id="date" required />
      </div>

      <div class="form-group">
        <label for="branch">üè• Branch</label>
        <select id="branch" required>
          <option value="">Select Branch</option>
          <option value="Malelane">Malelane</option>
          <option value="Komatipoort">Komatipoort</option>
          <option value="Nelspruit">Nelspruit</option>
        </select>
      </div>

      <div class="form-group">
        <label for="product-select">üì¶ Product</label>
        <select id="product-select" required>
          <!-- Product options -->
          <option value="Syringes">Syringes</option>
          <option value="Gloves">Gloves</option>
          <option value="Bandages">Bandages</option>
          <option value="IV Bags">IV Bags</option>
          <option value="Face Masks">Face Masks</option>
          <option value="Sanitizers">Sanitizers</option>
          <option value="Thermometers">Thermometers</option>
          <option value="Stethoscopes">Stethoscopes</option>
          <option value="BP Monitors">BP Monitors</option>
          <option value="Surgical Blades">Surgical Blades</option>
          <option value="Scalpels">Scalpels</option>
          <option value="Sutures">Sutures</option>
          <option value="Cannulas">Cannulas</option>
          <option value="Needles">Needles</option>
          <option value="Drip Stands">Drip Stands</option>
          <option value="Specimen Containers">Specimen Containers</option>
          <option value="Urine Bags">Urine Bags</option>
          <option value="Catheters">Catheters</option>
          <option value="Oxygen Masks">Oxygen Masks</option>
          <option value="Pulse Oximeters">Pulse Oximeters</option>
          <option value="Wheelchairs">Wheelchairs</option>
          <option value="Hospital Beds">Hospital Beds</option>
          <option value="Disinfectant Wipes">Disinfectant Wipes</option>
          <option value="Gauze">Gauze</option>
          <option value="Plasters">Plasters</option>
          <option value="Thermal Blankets">Thermal Blankets</option>
          <option value="IV Cannulas">IV Cannulas</option>
          <option value="ECG Machines">ECG Machines</option>
          <option value="Defibrillators">Defibrillators</option>
          <option value="Surgical Gowns">Surgical Gowns</option>
          <option value="Surgical Caps">Surgical Caps</option>
          <option value="Shoe Covers">Shoe Covers</option>
          <option value="Medical Tapes">Medical Tapes</option>
          <option value="Antibiotic Ointments">Antibiotic Ointments</option>
          <option value="Ointments and Creams">Ointments and Creams</option>
          <option value="Eye Drops">Eye Drops</option>
          <option value="Alcohol Swabs">Alcohol Swabs</option>
          <option value="Other">Other</option>
        </select>
        <input type="text" id="product-other" placeholder="Custom Product" style="display: none;" />
      </div>

      <div class="form-group">
        <label for="quantity">üî¢ Quantity</label>
        <input type="number" id="quantity" placeholder="Enter Quantity" min="1" required />
      </div>

      <button type="submit" class="btn-primary">‚ûï Add Entry</button>
    </form>

    <div class="toast" id="toast" role="alert" style="display:none;">‚úî Entry added successfully!</div>

    <div id="table-container">
      <h2>üìä Stock Entries</h2>
      <table id="stock-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Branch</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button class="btn-secondary" onclick="downloadPDF()">‚¨á Download PDF</button>
    </div>
  </div>

  <script>
    const form = document.getElementById('stock-form');
    const tableBody = document.querySelector('#stock-table tbody');
    const productSelect = document.getElementById('product-select');
    const productOther = document.getElementById('product-other');
    const toast = document.getElementById('toast');

    const SCRIPT_URL = 'https://sheetdb.io/api/v1/vqe73unkshywj';

    productSelect.addEventListener('change', () => {
      if (productSelect.value === 'Other') {
        productOther.style.display = 'block';
        productOther.required = true;
      } else {
        productOther.style.display = 'none';
        productOther.required = false;
        productOther.value = '';
      }
    });

    function generateUniqueId() {
      return Date.now().toString();
    }

    function convertSerialToDate(serial) {
      const excelEpoch = new Date(1899, 11, 30);
      const days = parseFloat(serial);
      if (isNaN(days)) return serial;
      const ms = days * 86400000;
      const date = new Date(excelEpoch.getTime() + ms);
      return date.toISOString().split('T')[0];
    }

    function addRow(date, branch, product, quantity, rowId) {
      const cleanDate = /^\d+(\.\d+)?$/.test(date) ? convertSerialToDate(date) : date;
      const row = tableBody.insertRow();
      row.innerHTML = `
        <td>${cleanDate}</td>
        <td>${branch}</td>
        <td>${product}</td>
        <td>${quantity}</td>
        <td><button class="btn-delete">üóëÔ∏è Delete</button></td>
      `;
      row.dataset.rowId = rowId;

      row.querySelector('.btn-delete').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        try {
          const deleteUrl = `${SCRIPT_URL}/id/${encodeURIComponent(rowId)}`;
          const res = await fetch(deleteUrl, { method: 'DELETE' });
          if (res.ok) {
            row.remove();
            showToast('üóëÔ∏è Entry deleted.');
          } else {
            alert('Failed to delete entry.');
          }
        } catch (err) {
          console.error(err);
          alert('Error deleting entry.');
        }
      });
    }

    function showToast(message) {
      toast.innerText = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, 3000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const date = form.date.value;
      const branch = form.branch.value.trim();
      const quantity = form.quantity.value;
      const product = productSelect.value === 'Other' ? productOther.value.trim() : productSelect.value;

      if (!date || !branch || !product || !quantity || quantity <= 0) {
        alert('Please fill in all fields with valid values.');
        return;
      }

      const uniqueId = generateUniqueId();
      const postData = {
        data: [{
          id: uniqueId,
          date,
          branch,
          product,
          quantity
        }]
      };

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData)
        });

        if (response.ok) {
          addRow(date, branch, product, quantity, uniqueId);
          form.reset();
          productOther.style.display = 'none';
          productOther.required = false;
          showToast('‚úî Entry added successfully!');
        } else {
          const result = await response.json();
          alert('Failed to save data: ' + (result.message || 'Unknown error'));
        }
      } catch (error) {
        console.error(error);
        alert('Error saving data.');
      }
    });

    async function loadEntries() {
      try {
        const response = await fetch(SCRIPT_URL);
        if (!response.ok) throw new Error('Failed to fetch entries');
        const data = await response.json();
        tableBody.innerHTML = '';
        data.forEach(entry => {
          const rowId = entry.id || generateUniqueId();
          addRow(entry.date, entry.branch, entry.product, entry.quantity, rowId);
        });
      } catch (error) {
        console.error(error);
      }
    }

    function downloadPDF() {
      const element = document.getElementById('table-container');
      html2pdf().set({
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: 'Health_Stock_Report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, scrollY: 0 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
      }).from(element).save();
    }

    loadEntries();
  </script>
</body>
</html>
